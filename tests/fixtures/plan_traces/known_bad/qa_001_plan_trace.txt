{
  "stage": "before_normalize",
  "plan": {
    "required_context": [
      "demo_qa"
    ],
    "context_plan": [
      {
        "provider": "demo_qa",
        "mode": "slice",
        "selectors": {
          "op": "query",
          "root_entity": "customers",
          "select": [
            {
              "expr": "city",
              "alias": "city"
            },
            {
              "expr": "segment",
              "alias": "segment"
            },
            {
              "expr": "signup_date",
              "alias": "signup_date"
            }
          ],
          "filters": {
            "type": "comparison",
            "field": "customer_id",
            "op": "=",
            "value": 42
          },
          "relations": [
            "orders_to_customers"
          ],
          "group_by": [
            {
              "field": "customer_id",
              "alias": "customer_id"
            }
          ],
          "aggregations": [
            {
              "field": "order_id",
              "agg": "count",
              "alias": "order_count"
            },
            {
              "field": "order_total",
              "agg": "sum",
              "alias": "total_spent"
            }
          ],
          "limit": 1
        },
        "max_tokens": null
      },
      {
        "provider": "demo_qa",
        "mode": "slice",
        "selectors": {
          "op": "query",
          "root_entity": "orders",
          "select": [
            {
              "expr": "order_date",
              "alias": "last_order_date"
            },
            {
              "expr": "order_status",
              "alias": "last_order_status"
            },
            {
              "expr": "order_channel",
              "alias": "last_order_channel"
            }
          ],
          "filters": {
            "type": "comparison",
            "field": "customer_id",
            "op": "=",
            "value": 42
          },
          "limit": 1,
          "order_by": [
            {
              "field": "order_date",
              "direction": "desc"
            }
          ]
        },
        "max_tokens": null
      },
      {
        "provider": "demo_qa",
        "mode": "slice",
        "selectors": {
          "op": "query",
          "root_entity": "order_items",
          "select": [
            {
              "expr": "line_total",
              "alias": "line_total"
            }
          ],
          "filters": {
            "type": "comparison",
            "field": "order_id",
            "op": "in",
            "value": "(SELECT order_id FROM orders WHERE customer_id = 42)"
          },
          "limit": 5,
          "order_by": [
            {
              "field": "line_total",
              "direction": "desc"
            }
          ]
        },
        "max_tokens": null
      }
    ],
    "adr_queries": [],
    "constraints": [],
    "entities": [],
    "dtos": [],
    "normalization_notes": [
      "{\"provider\": \"demo_qa\", \"selectors_validate_before\": \"ok\", \"selectors_validate_after\": \"ok\", \"selectors_normalization_decision\": \"keep_original_valid\"}",
      "{\"provider\": \"demo_qa\", \"selectors_validate_before\": \"ok\", \"selectors_validate_after\": \"ok\", \"selectors_normalization_decision\": \"keep_original_valid\"}",
      "{\"provider\": \"demo_qa\", \"selectors_validate_before\": \"ok\", \"selectors_validate_after\": \"ok\", \"selectors_normalization_decision\": \"keep_original_valid\"}"
    ]
  }
}
